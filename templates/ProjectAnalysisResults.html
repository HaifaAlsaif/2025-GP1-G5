<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1, width=device-width"/>
  <title>Analysis Results ‚Ä¢ TrustLens</title>
  <style>
    :root {
      --bg: #fff;
      --text: #0a0a0a;
      --muted: #717182;
      --line: rgba(0,0,0,.10);
      --primary1: #00B8DB;
      --primary2: #155DFC;
      --radius: 14px;
      --success: #0A7A39;
      --warning: #F59E0B;
      --danger: #B42318;
      --human-bg: rgba(10, 122, 57, 0.1);
      --human-border: #84fab0;
      --ai-bg: rgba(245, 158, 11, 0.1);
      --ai-border: #fbbf24;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background: #fafafa;
    }

    /* Header */
    .mast {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: #fff;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 clamp(16px, 6vw, 134.8px);
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand img {
      width: 32px;
      height: 32px;
    }

    .brand-name {
      font-size: 20px;
      background: linear-gradient(90deg, var(--primary1), var(--primary2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 600;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary1), var(--primary2));
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 80px auto 40px;
      padding: 0 clamp(16px, 4vw, 40px);
    }

    /* Page Header */
    .page-header {
      margin-bottom: 32px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .back-link:hover {
      color: var(--text);
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 16px;
      margin: 0;
    }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .summary-card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary1), var(--primary2));
    }

    .summary-card.human::before {
      background: linear-gradient(90deg, #0A7A39, #84fab0);
    }

    .summary-card.ai::before {
      background: linear-gradient(90deg, #F59E0B, #fbbf24);
    }

    .card-label {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    /* Action Bar */
    .action-bar {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .search-box {
      flex: 1;
      min-width: 280px;
      max-width: 400px;
      position: relative;
    }

    .search-input {
      width: 100%;
      height: 40px;
      padding: 0 16px 0 40px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #f9f9fb;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 12px;
      width: 16px;
      height: 16px;
      opacity: 0.5;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .btn {
      height: 40px;
      padding: 0 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--primary1), var(--primary2));
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 184, 219, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #fff;
      border: 1px solid var(--line);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #f9f9fb;
    }

    /* Results Table */
    .results-container {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9f9fb;
      border-bottom: 1px solid var(--line);
    }

    th {
      padding: 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f9f9fb;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .article-title {
      font-weight: 500;
      color: var(--text);
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 9999px;
      font-size: 13px;
      font-weight: 600;
    }

    .badge.human {
      background: var(--human-bg);
      border: 1px solid var(--human-border);
      color: var(--success);
    }

    .badge.ai {
      background: var(--ai-bg);
      border: 1px solid var(--ai-border);
      color: var(--warning);
    }

    .percentage {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }

    /* Loading & Empty States */
    .loading, .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }

      .action-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: none;
      }

      .action-buttons {
        justify-content: stretch;
      }

      .btn {
        flex: 1;
      }

      th, td {
        padding: 12px;
      }

      .article-title {
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="mast">
    <div class="brand">
      <img src="../static/images/icon_logo.svg" alt="TrustLens">
      <div class="brand-name">TrustLens</div>
    </div>
    <div class="user-info">
      <span id="userName">User</span>
      <div class="avatar" id="userAvatar">U</div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <a href="#" class="back-link" id="backLink">
        ‚Üê Back to Project
      </a>
      <h1 class="page-title" id="projectTitle">Analysis Results</h1>
      <p class="page-subtitle" id="datasetInfo">Loading dataset information...</p>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
      <div class="summary-card">
        <div class="card-label">Total Articles</div>
        <div class="card-value" id="totalArticles">-</div>
        <div class="card-subtitle">Analyzed articles</div>
      </div>

      <div class="summary-card human">
        <div class="card-label">Human Written</div>
        <div class="card-value" id="humanCount">-</div>
        <div class="card-subtitle" id="humanPercentage">-% of total</div>
      </div>

      <div class="summary-card ai">
        <div class="card-label">AI Generated</div>
        <div class="card-value" id="aiCount">-</div>
        <div class="card-subtitle" id="aiPercentage">-% of total</div>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="search-box">
        <svg class="search-icon" viewBox="0 0 16 16" fill="currentColor">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search articles...">
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="runAnalysisBtn">
          üîç Run Analysis
        </button>
        <button class="btn btn-secondary" id="exportBtn">
          üì• Export CSV
        </button>
      </div>
    </div>

    <!-- Results Table -->
    <div class="results-container">
      <div class="loading" id="loadingState">
        <div class="spinner"></div>
        <p>Loading analysis results...</p>
      </div>

      <div class="empty-state" id="emptyState" style="display: none;">
        <p>üìä No analysis results yet</p>
        <p style="margin-top: 8px;">Click "Run Analysis" to analyze all articles in this dataset</p>
      </div>

      <div class="table-wrapper" id="tableWrapper" style="display: none;">
        <table>
          <thead>
            <tr>
              <th>Article Title</th>
              <th>Prediction</th>
              <th>Human %</th>
              <th>AI %</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="resultsTable">
            <!-- Results will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  
// ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ project_id ŸÖŸÜ URL path

const pathParts = window.location.pathname.split('/');
const projectId = pathParts[2]; // project_id ŸáŸà ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´

    if (!projectId) {
      alert('Missing project ID');
      window.location.href = '/myprojectowner';
    }

    // Set back link
    document.getElementById('backLink').href = `/projectdetailsowner/${projectId}`;

    // Load initial data
    async function loadAnalysisResults() {
      try {
        // Try to load existing analysis from RTDB
        const response = await fetch(`/api/project/${projectId}/analysis_results`);
        
        if (response.ok) {
          const data = await response.json();
          displayResults(data);
        } else {
          // No analysis yet
          showEmptyState();
        }
      } catch (error) {
        console.error('Error loading results:', error);
        showEmptyState();
      }
    }

    function showEmptyState() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('tableWrapper').style.display = 'none';
    }

    function displayResults(data) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('tableWrapper').style.display = 'block';

      const summary = data.summary || {};
      const details = data.details || [];

      // Update summary cards
      document.getElementById('totalArticles').textContent = summary.total_articles || 0;
      document.getElementById('humanCount').textContent = summary.human_count || 0;
      document.getElementById('aiCount').textContent = summary.ai_count || 0;
      document.getElementById('humanPercentage').textContent = `${summary.human_percentage || 0}% of total`;
      document.getElementById('aiPercentage').textContent = `${summary.ai_percentage || 0}% of total`;
      document.getElementById('datasetInfo').textContent = `Dataset analyzed on ${new Date(summary.analyzed_at).toLocaleString()}`;

      // Populate table
      const tbody = document.getElementById('resultsTable');
      tbody.innerHTML = '';

      details.forEach(article => {
        const row = document.createElement('tr');
        
        const isHuman = article.prediction === 'Human';
        const confidence = Math.max(article.human_percentage, article.ai_percentage);

        row.innerHTML = `
          <td>
            <div class="article-title" title="${article.title}">${article.title || 'Untitled'}</div>
          </td>
          <td>
            <span class="badge ${isHuman ? 'human' : 'ai'}">
              ${isHuman ? '‚úçÔ∏è' : 'ü§ñ'} ${article.prediction}
            </span>
          </td>
          <td><span class="percentage">${article.human_percentage}%</span></td>
          <td><span class="percentage">${article.ai_percentage}%</span></td>
          <td><span class="percentage">${confidence.toFixed(2)}%</span></td>
        `;

        tbody.appendChild(row);
      });
    }

    // Run Analysis
    document.getElementById('runAnalysisBtn').addEventListener('click', async () => {
      const btn = document.getElementById('runAnalysisBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Analyzing...';

      try {
        const response = await fetch(`/api/project/${projectId}/analyze_all`, {
          method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
          alert(`‚úÖ Analysis complete! Analyzed ${data.total_analyzed} articles`);
          loadAnalysisResults();
        } else {
          alert(`‚ùå ${data.error || 'Analysis failed'}`);
        }
      } catch (error) {
        console.error('Analysis error:', error);
        alert('‚ùå Network error during analysis');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Run Analysis';
      }
    });

    // Export CSV
    document.getElementById('exportBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`/api/project/${projectId}/analysis_results`);
        const data = await response.json();

        if (!data.details || data.details.length === 0) {
          alert('No results to export');
          return;
        }

        // Create CSV
        const headers = ['Article ID', 'Title', 'Prediction', 'Human %', 'AI %'];
        const rows = data.details.map(a => [
          a.article_id,
          `"${a.title.replace(/"/g, '""')}"`,
          a.prediction,
          a.human_percentage,
          a.ai_percentage
        ]);

        const csv = [
          headers.join(','),
          ...rows.map(r => r.join(','))
        ].join('\n');

        // Download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analysis_results_${projectId}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);

      } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export results');
      }
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#resultsTable tr');

      rows.forEach(row => {
        const title = row.querySelector('.article-title').textContent.toLowerCase();
        row.style.display = title.includes(query) ? '' : 'none';
      });
    });

    // Load results on page load
    loadAnalysisResults();
  </script>
</body>
</html>
